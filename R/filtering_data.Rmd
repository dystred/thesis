---
title: "Filtering the data"
author:
  - Marie Dyveke Olafsen 
output: 
  html_document:
    toc: true
    toc_depth: 2
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
# set default chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE,
  autodep = TRUE
  )
```

# Setup

```{r}
source("/Users/mariedyveke/Documents/GitHub/thesis/R/Lib.R")

setwd <- "/Users/mariedyveke/Documents/GitHub/thesis"
datapath <- "/Users/mariedyveke/Documents/GitHub/thesis/data"
sqlpath <- "/Users/mariedyveke/Documents/GitHub/thesis/SQL"
```

Importing and transforming the data

```{r}
datafiles <- list.files(datapath) %>% 
  str_split_fixed(pattern="_",n=5) %>% 
  as_tibble()

permno_files <- datafiles %>%
  dplyr::filter(V2 == "PERMNOtoTICKER")
returns_files <- datafiles %>% 
  dplyr::filter(V1 == "CRSP" & V2 == "allstocks" & V3 == "daily" & V4 == "raw")

permno_data <- read_csv(file = paste0(datapath,"/",permno_files$V1,"_",permno_files$V2,"_",permno_files$V3), show_col_types = FALSE)

# Unique Permno and tickers - for matching tickers to daily returns
permnos <- permno_data %>% summarize(uniq = unique(permno)) %>% nrow()
permtoticker <- permno_data %>% dplyr::filter(!is.na(ticker))  %>% dplyr::select(permno,ticker) %>% unique()

moretickerstoperms <- permtoticker %>% 
  dplyr::group_by(permno) %>% 
  dplyr::mutate(tickerstoperm = row_number()) %>% 
  dplyr::filter(tickerstoperm>1) %>% 
  dplyr::select(permno) %>% 
  unique()

# Finding the date of the change in ticker:
permno_data %>% 
  dplyr::filter((permno %in% moretickerstoperms$permno) & !is.na(ticker)) %>% 
  dplyr::group_by(permno) %>% 
  dplyr::mutate(first_ = row_number()==1,
                keep_ = row_number()==1 | ticker!=dplyr::lag(ticker)) %>% 
  dplyr::filter(keep_)

uniq_permnos <- permno_data %>% summarize(uniq = unique(permno))
rm(permno_data)

years <- 1996:2023

# Calculating weekly/monthly returns + relevant measures

for(year in years){
  
  tmp_data <- read_csv(file = paste0(datapath,"/",returns_files$V1,"_",returns_files$V2,"_",returns_files$V3,"_",returns_files$V4,"_",year,".csv"), show_col_types = FALSE) %>% 
    dplyr::mutate(week = week(date),
                  month = month(date),
                  bidaskspread = ask-bid,
                  numtrd = ifelse(numtrd == 99, 0, numtrd),
                  vol = ifelse(vol<0,NA,vol),
                  prc = ifelse(prc<0,NA,prc),
                  bidaskaverage = ifelse(prc<0,-prc,NA))
  
  tmp_data %>% 
    dplyr::group_by(permno,week) %>% 
    summarize(date = min(date),
              bidlo = min(c(bidlo,1000000), na.rm = TRUE),
              askhi = max(c(0,askhi), na.rm = TRUE),
              closingprice = tail(prc,n=1, na.rm = TRUE),
              openprice = head(openprc,n=1, na.rm = TRUE),
              return = (closingprice-openprice)/openprice,
              volume = sum(vol, na.rm = TRUE),
              bidaskspread = mean(bidaskspread, na.rm = TRUE),
              trades = sum(numtrd, na.rm = TRUE),
              .groups="keep") %>% 
    write_csv(file = paste0(datapath,"/CRSP_allstocks_weekly_raw",year,".csv"))
  
  tmp_data %>% 
    dplyr::group_by(permno,month) %>% 
    summarize(date = min(date),
              bidlo = min(c(bidlo,1000000), na.rm = TRUE),
              askhi = max(c(0,askhi), na.rm = TRUE),
              closingprice = tail(prc,n=1, na.rm = TRUE),
              openprice = head(openprc,n=1, na.rm = TRUE),
              return = (closingprice-openprice)/openprice,
              volume = sum(vol, na.rm = TRUE),
              bidaskspread = mean(bidaskspread, na.rm = TRUE),
              trades = sum(numtrd, na.rm = TRUE),
              .groups="keep") %>% 
    write_csv(file = paste0(datapath,"/CRSP_allstocks_monthly_raw",year,".csv"))
  
  rm(tmp_data)
}

```

# Overview of Data

```{r}

years <- 1996:2022

for(i in 7:permnos){
  print(i/permnos)
  tmp_data_total = tibble()
  tmp_permno <- uniq_permnos$uniq[i]
  
  for(step in years){
    # print(step)
    tmp_data <- read_csv(file = paste0(datapath,"/",returns_files$V1,"_",returns_files$V2,"_monthly_",returns_files$V4,"_",step,".csv"), show_col_types = FALSE) %>% 
      dplyr::filter(permno == tmp_permno)
    
    tmp_data_total <- rbind(tmp_data_total,tmp_data)
  }
  
  tmp_data_total %>% unique() %>% write_csv(file = paste0(datapath,"/specific_stocks/CRSP_",tmp_permno,"_monthly_raw.csv")) 
  rm(tmp_data_total)
}
```



## Colophon 
<!-- Always keep this section for reproducibility -->

This report has been created inside [RStudio](http://www.rstudio.com/ide/) using [R Markdown](https://rmarkdown.rstudio.com/). 

The report was built using:

```{r message = FALSE, warning = FALSE, echo = FALSE}
session <- devtools::session_info()
session$platform
```

Along with these packages:

```{r message = FALSE, warning = FALSE, echo = FALSE}
session$packages %>% 
  select(package, loadedversion, date, source) %>% 
  DT::datatable(rownames = FALSE,
                class = 'cell-border stripe',
                filter = list(position = 'top'),
                options = list(pageLength = 5, 
                           autoWidth = FALSE,
                           bInfo = FALSE,
                           paging = TRUE))